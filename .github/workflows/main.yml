name: Build Kernel from XiaoMi8-byXinRan
on:
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel from XiaoMi8-byXinRan
    runs-on: ubuntu-22.04
    steps:

      - name: Get branch names.
        id: branch-names
        uses: tj-actions/branch-names@v8

      - name: Set SWAP to 5GiB
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 5

      - name: Initialize compilation environment
        run: |
          sudo apt-get update
          sudo apt-get install git automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python2 python3
          sudo apt install -y gcc-arm-linux-gnueabihf
          mkdir -p $GITHUB_WORKSPACE/workdir
          cd $GITHUB_WORKSPACE/workdir
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: Get zyc-clang20 toolchain
        run: |
          wget https://github.com/ZyCromerZ/Clang/releases/download/20.0.0git-20250129-release/Clang-20.0.0git-20250129.tar.gz -O $GITHUB_WORKSPACE/workdir/zyc_clang20.tar.gz
          mkdir $GITHUB_WORKSPACE/workdir/clang
          tar zxvf $GITHUB_WORKSPACE/workdir/zyc_clang20.tar.gz -C $GITHUB_WORKSPACE/workdir/clang

      - name: Get Kernel souce
        run: |
          git clone --recursive https://github.com/Winkmoon/LawRun_xiaomi_sdm845_CAF -b master --depth 1 $GITHUB_WORKSPACE/workdir/source


      - name: Integration SukiSU
        run: |
          cd $GITHUB_WORKSPACE/workdir/source
          rm -rf KernelSU
          echo "正在配置SukiSU Ultra..."
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s nongki
          cd ./KernelSU


          
          # 获取当前 Git 提交的短哈希 (8位)
          GIT_COMMIT_HASH=$(git rev-parse --short=8 HEAD)
          echo "当前提交哈希: $GIT_COMMIT_HASH"
          export KSU_VERSION=$KSU_VERSION
          # 尝试最多 3 次获取 KernelSU API 版本号
          for i in {1..3}; do
          # 从远程 Makefile 中提取 KSU_API_VERSION
          KSU_API_VERSION=$(curl -s "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/nongki/kernel/Makefile" | 
          # 查找第一个包含版本定义的行
          grep -m1 "KSU_VERSION_API :=" | 
          # 提取等号后的值
          awk -F'= ' '{print $2}' | 
          # 删除所有空白字符
          tr -d '[:space:]')
          # 如果成功获取到版本号则跳出循环，否则等待 1 秒后重试
          [ -n "$KSU_API_VERSION" ] && break || sleep 1
          done
          # 如果获取失败，使用默认版本号 4.0.0
          [ -z "$KSU_API_VERSION" ] && KSU_API_VERSION="4.0.0"
          # 将 API 版本号存储到 GitHub 环境变量
          echo "KSU_API_VERSION=$KSU_API_VERSION" >> $GITHUB_ENV
          # 创建版本定义模板&版本格式函数: 使用获取的提交哈希和固定后缀
          # KSU_VERSION_API: API 版本定义
          # KSU_VERSION_FULL: 完整版本定义
          VERSION_DEFINITIONS=$'define get_ksu_version_full\nv\\$1-'"$GIT_COMMIT_HASH"$'@Xinran_StarBai\nendef\n\nKSU_VERSION_API := '"$KSU_API_VERSION"$'\nKSU_VERSION_FULL := v'"$KSU_API_VERSION"$'-'"$GIT_COMMIT_HASH"$'@Xinran_StarBai'
          # 清理内核 Makefile 中的旧版本定义
          # 删除版本函数
          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Makefile
          # 删除 API 版本定义
          sed -i '/KSU_VERSION_API :=/d' kernel/Makefile
          # 删除完整版本定义
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Makefile
          # 在 REPO_OWNER 行后插入新版本定义
          awk -v def="$VERSION_DEFINITIONS" '
          # 当找到 REPO_OWNER 行时，插入版本定义并设置标记
          /REPO_OWNER :=/ {print; print def; inserted=1; next}
          # 打印所有行
          1
          # 如果未找到插入点，在文件末尾追加
          END {if (!inserted) print def}
          ' kernel/Makefile > kernel/Makefile.tmp && mv kernel/Makefile.tmp kernel/Makefile



          # 生成自定义版本号（基于提交计数）, 失败时使用 343263
          KSU_VERSION=$(expr $(git rev-list --count main) + 37185 2>/dev/null || echo 343263)
          # 存储版本号到 GitHub 环境变量
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT



          # 验证修改结果
          grep -A10 "REPO_OWNER" kernel/Makefile  # 检查插入点后的内容
          grep "KSU_VERSION_FULL" kernel/Makefile # 确认版本定义存在
          echo "SukiSU版本号: v${KSU_API_VERSION}-${GIT_COMMIT_HASH}@Xinran_StarBai"


          

      - name: Build Kernel
        run: |
          cd $GITHUB_WORKSPACE/workdir/source
          export KBUILD_BUILD_HOST=XinRan
          export KBUILD_BUILD_USER=StarBai
          export ARCH="arm64"
          export SUBARCH="arm64"
          export PATH="$GITHUB_WORKSPACE/workdir/clang/bin/:$PATH"
          export CROSS_COMPILE="aarch64-linux-gnu-"
          export CROSS_COMPILE_ARM32="arm-linux-gnueabihf-"
          
          make O=out LawRun_defconfig CC=clang
          #echo "CONFIG_LITTLE_CPU_MASK=0xf" >> out/.config
          #echo "CONFIG_BIG_CPU_MASK=0xf0" >> out/.config
          make -j$(nproc --all) O=out CC=clang

      - name: Check a kernel output files
        run: |
          cd $GITHUB_WORKSPACE/workdir/source
          if [ -f out/arch/arm64/boot/Image.gz-dtb ]; then
              echo "CHECK_FILE_IS_OK=true" >> $GITHUB_ENV
          else
              echo "Kernel output file is empty"
              exit 1
          fi

      - name: Upload Kernel
        if: env.CHECK_FILE_IS_OK == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android_kernel_xiaomi_sdm845_xinran_${{ env.BUILD_TIME }}_Image.gz-dtb
          path: workdir/source/out/arch/arm64/boot/Image.gz-dtb
  
      - name: Make Anykernel3
        if: env.CHECK_FILE_IS_OK == 'true'
        run: |
          git clone https://github.com/Winkmoon/AnyKernel3 -b master --depth 1 $GITHUB_WORKSPACE/workdir/ak3
          rm -r $GITHUB_WORKSPACE/workdir/ak3/.git
          cp $GITHUB_WORKSPACE/workdir/source/out/arch/arm64/boot/Image.gz-dtb $GITHUB_WORKSPACE/workdir/ak3

      - name: Upload AnyKernel3
        if: env.CHECK_FILE_IS_OK == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_xiaomi_sdm845_xinran_${{ env.BUILD_TIME }}
          path: workdir/ak3/*
